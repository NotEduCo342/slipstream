name: Build Slipstream

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-linux:
    name: Build on Linux (amd64)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y meson cmake pkg-config libssl-dev ninja-build clang

    - name: Configure Meson
      run: meson setup --buildtype=release -Db_lto=true --warnlevel=0 build

    - name: Compile
      run: meson compile -C build

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: slipstream-binaries-linux
        path: |
          build/slipstream-client
          build/slipstream-server

  build-windows:
    name: Build on Windows (amd64)
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        pip install meson ninja
        choco install openssl --no-progress
        choco install pkgconfiglite

    - name: Resolve OpenSSL paths
      shell: pwsh
      run: |
        $possible_roots = @(
          "C:\Program Files\OpenSSL-Win64",
          "C:\Program Files\OpenSSL",
          "C:\OpenSSL-Win64",
          "C:\OpenSSL"
        )
        $openssl_root = $possible_roots | Where-Object { Test-Path $_ } | Select-Object -First 1
        if (-not $openssl_root) {
          Write-Error "OpenSSL root not found."
          exit 1
        }

        $crypto = Get-ChildItem -Path $openssl_root -Recurse -Filter "libcrypto.lib" | Select-Object -First 1
        $ssl = Get-ChildItem -Path $openssl_root -Recurse -Filter "libssl.lib" | Select-Object -First 1
        if (-not $crypto -or -not $ssl) {
          Write-Error "OpenSSL libraries not found under $openssl_root"
          exit 1
        }

        $include_dir = Join-Path $openssl_root "include"
        if (-not (Test-Path $include_dir)) {
          Write-Error "OpenSSL include dir not found: $include_dir"
          exit 1
        }

        "OPENSSL_ROOT_DIR=$openssl_root" >> $env:GITHUB_ENV
        "OPENSSL_CRYPTO_LIBRARY=$($crypto.FullName)" >> $env:GITHUB_ENV
        "OPENSSL_SSL_LIBRARY=$($ssl.FullName)" >> $env:GITHUB_ENV
        "OPENSSL_INCLUDE_DIR=$include_dir" >> $env:GITHUB_ENV

    - name: Debug OpenSSL environment
      shell: pwsh
      run: |
        Write-Host "OPENSSL_ROOT_DIR=$env:OPENSSL_ROOT_DIR"
        Write-Host "OPENSSL_CRYPTO_LIBRARY=$env:OPENSSL_CRYPTO_LIBRARY"
        Write-Host "OPENSSL_SSL_LIBRARY=$env:OPENSSL_SSL_LIBRARY"
        Write-Host "OPENSSL_INCLUDE_DIR=$env:OPENSSL_INCLUDE_DIR"
        Write-Host "--- Listing OpenSSL root ---"
        Get-ChildItem -Path $env:OPENSSL_ROOT_DIR -Recurse | Select-Object FullName

    - name: Configure Meson
      id: meson_configure
      shell: pwsh
      continue-on-error: true
      run: |
        echo "Using OpenSSL at: $env:OPENSSL_ROOT_DIR"

        # Normalize paths to forward slashes to avoid CMake escaping issues
        $root_dir = $env:OPENSSL_ROOT_DIR -replace '\\', '/'
        $crypto_lib = $env:OPENSSL_CRYPTO_LIBRARY -replace '\\', '/'
        $ssl_lib = $env:OPENSSL_SSL_LIBRARY -replace '\\', '/'
        $include_dir = $env:OPENSSL_INCLUDE_DIR -replace '\\', '/'

        echo "Normalized paths:"
        echo "Root: $root_dir"
        echo "Crypto: $crypto_lib"
        echo "SSL: $ssl_lib"
        echo "Include: $include_dir"

        # Pass options to Meson
        meson setup --buildtype=release -Db_lto=false --warnlevel=0 build `
            "-Dopenssl_root=$root_dir" `
            "-Dopenssl_crypto_lib=$crypto_lib" `
            "-Dopenssl_ssl_lib=$ssl_lib" `
            "-Dopenssl_include=$include_dir"

    - name: Show Meson log
      if: always()
      shell: pwsh
      run: |
        if (Test-Path "build/meson-logs/meson-log.txt") {
          Get-Content "build/meson-logs/meson-log.txt"
        } else {
          Write-Host "No meson log found."
        }

    - name: Fail if Meson configure failed
      if: steps.meson_configure.outcome != 'success'
      shell: pwsh
      run: exit 1

    - name: Compile
      run: meson compile -C build

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: slipstream-binaries-windows
        path: |
          build/slipstream-client.exe
          build/slipstream-server.exe

